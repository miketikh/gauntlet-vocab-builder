# Database Migrations with Alembic

This directory contains database migrations for the Vocab Builder API using Alembic.

## Overview

Alembic is a database migration tool for SQLAlchemy/SQLModel. It allows you to:
- Track database schema changes over time
- Generate migrations automatically from SQLModel models
- Apply migrations to keep database in sync with code
- Roll back changes if needed

## Prerequisites

- Python 3.9+ with dependencies installed (`pip install -r requirements.txt`)
- DATABASE_URL configured in `.env` file
- Access to Supabase PostgreSQL database

## Common Commands

### Generate a new migration (autogenerate from models)

```bash
cd /api
alembic revision --autogenerate -m "Description of changes"
```

This will:
1. Compare current database schema to SQLModel models
2. Generate a migration file in `alembic/versions/`
3. Include detected changes (new tables, columns, etc.)

**Always review the generated migration before applying!**

### Apply migrations (upgrade to latest)

```bash
alembic upgrade head
```

This applies all pending migrations to bring the database up to date.

### View current migration status

```bash
alembic current
```

Shows which migration version the database is currently at.

### View migration history

```bash
alembic history
```

Shows all migrations and their status.

### Rollback one migration

```bash
alembic downgrade -1
```

### Rollback to specific migration

```bash
alembic downgrade <revision_id>
```

### Create empty migration (for data migrations)

```bash
alembic revision -m "Add default grade words"
```

Then manually edit the generated file to add data operations.

## Migration Workflow

### 1. Make changes to SQLModel models

Edit files in `/api/models/database.py`:

```python
class Student(SQLModel, table=True):
    # ... existing fields ...
    new_field: Optional[str] = None  # Add new field
```

### 2. Generate migration

```bash
alembic revision --autogenerate -m "Add new_field to students table"
```

### 3. Review the generated migration

Open the file in `alembic/versions/` and verify the changes:

```python
def upgrade() -> None:
    # Check that this does what you expect
    op.add_column('students', sa.Column('new_field', sa.String(), nullable=True))

def downgrade() -> None:
    # Check rollback behavior
    op.drop_column('students', 'new_field')
```

### 4. Apply the migration

```bash
alembic upgrade head
```

### 5. Commit both the model changes and migration file

```bash
git add models/database.py alembic/versions/<new_migration>.py
git commit -m "Add new_field to students table"
```

## Best Practices

### DO:
- Always review autogenerated migrations before applying
- Test migrations on development database first
- Commit migration files to version control
- Write descriptive migration messages
- Add indexes for frequently queried columns
- Make migrations reversible (proper downgrade logic)

### DON'T:
- Don't edit migration files after they've been applied
- Don't delete migration files from version control
- Don't run migrations manually with SQL (use Alembic)
- Don't forget to commit migration files
- Don't apply untested migrations to production

## Troubleshooting

### Migration fails with "relation already exists"

Your database might be out of sync. Options:
1. Drop the existing table/column manually
2. Skip that specific migration
3. Reset database (dev only): Drop all tables and run `alembic upgrade head`

### Alembic can't detect changes

Make sure:
1. Models are imported in `alembic/env.py`
2. SQLModel table=True is set on model classes
3. You're in the correct environment (check DATABASE_URL)

### "Can't locate revision identified by 'xxx'"

Migration history is corrupted. Check:
1. `alembic_version` table in database
2. Files in `alembic/versions/`
3. May need to manually fix version table

### Migration generates too many changes

This can happen if:
1. Database schema doesn't match any migration
2. Models have changed significantly
3. You're connecting to wrong database

Solution: Review changes carefully, may need to create manual migration.

## Initial Setup (Already Done)

For reference, initial setup was:

```bash
# Install Alembic
pip install alembic

# Initialize Alembic
alembic init alembic

# Configure alembic/env.py to import models
# Configure alembic.ini to use DATABASE_URL

# Generate initial migration
alembic revision --autogenerate -m "Initial schema"

# Apply migration
alembic upgrade head
```

## Environment Variables

Alembic uses the same DATABASE_URL as the FastAPI application:

```bash
# .env
DATABASE_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-us-east-2.pooler.supabase.com:6543/postgres
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com/)
- [Supabase PostgreSQL Docs](https://supabase.com/docs/guides/database)
